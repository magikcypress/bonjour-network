name: Raspberry Pi Tests

on:
  push:
    branches: [ main, develop ]
  pull_request:
    branches: [ main ]
  workflow_dispatch:

jobs:
  # Test avec runner auto-hÃ©bergÃ© (si disponible)
  raspberry-self-hosted:
    runs-on: self-hosted
    if: ${{ github.repository == 'votre-username/bonjour-network' }}
    
    steps:
    - uses: actions/checkout@v4
    
    - name: Check Raspberry Pi environment
      run: |
        echo "ğŸ“ Environnement Raspberry Pi dÃ©tectÃ©"
        uname -a
        cat /etc/os-release
        node --version
        npm --version
    
    - name: Install dependencies
      run: |
        npm ci
        cd client && npm ci
        cd ../server && npm ci
    
    - name: Test native Raspberry Pi
      run: |
        echo "ğŸ§ª Test natif Raspberry Pi..."
        
        # DÃ©marrer le serveur
        cd server
        npm start &
        sleep 10
        
        # Tester l'API
        curl -f http://localhost:5001/api/health || exit 1
        
        # Tester les outils systÃ¨me
        which nmap || echo "nmap non installÃ©"
        which arp || echo "arp non disponible"
        which ping || echo "ping non disponible"
        
        echo "âœ… Tests natifs Raspberry Pi rÃ©ussis"
    
    - name: Test WiFi scanning on Raspberry Pi
      run: |
        echo "ğŸ“¶ Test scan WiFi Raspberry Pi..."
        
        # VÃ©rifier les interfaces WiFi
        ip link show | grep wlan || echo "Aucune interface WiFi dÃ©tectÃ©e"
        
        # Tester les outils WiFi
        which iwlist || echo "iwlist non disponible"
        which iw || echo "iw non disponible"
        which nmcli || echo "nmcli non disponible"
        
        echo "âœ… Tests WiFi Raspberry Pi terminÃ©s"
    
    - name: Test Docker on Raspberry Pi
      run: |
        echo "ğŸ³ Test Docker sur Raspberry Pi..."
        
        # Tester Docker
        docker --version
        docker run --rm hello-world
        
        # Tester le build Docker
        docker build -f Dockerfile.raspberry-pi -t bonjour-network:raspberry-test .
        
        # Tester le container
        docker run --rm -d --name test-raspberry -p 5001:5001 bonjour-network:raspberry-test
        sleep 15
        curl -f http://localhost:5001/api/health || exit 1
        docker stop test-raspberry
        
        echo "âœ… Docker Raspberry Pi fonctionnel"
    
    - name: Test application features
      run: |
        echo "ğŸ”§ Test des fonctionnalitÃ©s de l'application..."
        
        # DÃ©marrer l'application
        cd server
        npm start &
        sleep 10
        
        # Tester les endpoints
        curl -f http://localhost:5001/api/health
        curl -f http://localhost:5001/api/devices
        curl -f http://localhost:5001/api/wifi
        curl -f http://localhost:5001/api/dns
        
        echo "âœ… FonctionnalitÃ©s de l'application testÃ©es"
    
    - name: Test network scanning
      run: |
        echo "ğŸŒ Test du scan rÃ©seau..."
        
        # Tester le scan rÃ©seau (si autorisÃ©)
        sudo nmap -sn 192.168.1.0/24 || echo "Scan rÃ©seau non autorisÃ©"
        
        # Tester les outils rÃ©seau
        arp -a
        ping -c 3 8.8.8.8
        
        echo "âœ… Tests rÃ©seau terminÃ©s"
    
    - name: Performance test
      run: |
        echo "âš¡ Test de performance..."
        
        # Test de temps de rÃ©ponse
        start_time=$(date +%s.%N)
        curl -s http://localhost:5001/api/health > /dev/null
        end_time=$(date +%s.%N)
        response_time=$(echo "$end_time - $start_time" | bc)
        echo "Temps de rÃ©ponse API: ${response_time}s"
        
        # Test d'utilisation mÃ©moire
        if pgrep -f "node.*index.js" > /dev/null; then
          memory_usage=$(ps -o rss= -p $(pgrep -f "node.*index.js") | awk '{sum+=$1} END {print sum/1024}')
          echo "Utilisation mÃ©moire: ${memory_usage}MB"
        fi
        
        echo "âœ… Tests de performance terminÃ©s"
    
    - name: Summary
      run: |
        echo ""
        echo "ğŸ“ Tests Raspberry Pi terminÃ©s !"
        echo "ğŸ“Š RÃ©sumÃ©:"
        echo "  âœ… Environnement Raspberry Pi"
        echo "  âœ… DÃ©pendances installÃ©es"
        echo "  âœ… Serveur dÃ©marrÃ©"
        echo "  âœ… API accessible"
        echo "  âœ… Outils systÃ¨me"
        echo "  âœ… Scan WiFi"
        echo "  âœ… Docker fonctionnel"
        echo "  âœ… FonctionnalitÃ©s application"
        echo "  âœ… Tests rÃ©seau"
        echo "  âœ… Performance"
        echo ""
        echo "ğŸ‰ Tous les tests Raspberry Pi sont passÃ©s !" 