name: Unified Tests

on:
  push:
    branches: [ main, develop ]
  pull_request:
    branches: [ main ]
  workflow_dispatch:

jobs:
  unified-test:
    runs-on: ubuntu-latest
    
    strategy:
      matrix:
        node-version: [18.x, 20.x]
    
    steps:
    - uses: actions/checkout@v4
    
    - name: Use Node.js ${{ matrix.node-version }}
      uses: actions/setup-node@v4
      with:
        node-version: ${{ matrix.node-version }}
        cache: 'npm'
    
    - name: Set up Docker Buildx
      uses: docker/setup-buildx-action@v3
    
    - name: Install dependencies
      run: |
        npm ci
        cd client && npm ci
        cd ../server && npm ci
    
    - name: Install test dependencies
      run: |
        npm install axios socket.io-client puppeteer
        cd client && npm install axios socket.io-client
        cd ../server && npm install axios socket.io-client
    
    - name: Verify Docker files
      run: |
        ./scripts/verify-docker-files.sh
    
    - name: Start server
      run: |
        cd server
        npm start &
        sleep 10
    
    - name: Start client
      run: |
        cd client
        npm start &
        sleep 15
    
    - name: Test API endpoints
      run: |
        echo "ðŸ” Test des endpoints API..."
        curl -f http://localhost:5001/api/health || exit 1
        curl -f http://localhost:3000 || exit 1
        echo "âœ… Endpoints API accessibles"
    
    - name: Test API functionality
      run: |
        echo "ðŸ§ª Test de la fonctionnalitÃ© API..."
        node tests/test-no-x.js
    
    - name: Test accessibility (system)
      run: |
        echo "ðŸŽ¯ Test d'accessibilitÃ© (systÃ¨me)..."
        node scripts/test-accessibility-system.js
    
    - name: Test accessibility (fallback)
      run: |
        echo "ðŸ”„ Test d'accessibilitÃ© (fallback)..."
        node scripts/test-accessibility.js
    
    - name: Test headless browser
      run: |
        echo "ðŸŒ Test navigateur headless..."
        node tests/test-headless.js
    
    - name: Test Docker build (main)
      run: |
        echo "ðŸ³ Test build Docker principal..."
        docker build -t bonjour-network-test .
        docker run --rm -d --name test-container -p 5001:5001 bonjour-network-test
        sleep 15
        curl -f http://localhost:5001/api/health || exit 1
        docker stop test-container
    
    - name: Test Docker build (Raspberry Pi)
      run: |
        echo "ðŸ“ Test build Docker Raspberry Pi..."
        docker build -f Dockerfile.raspberry-pi -t bonjour-network-raspberry-test .
        docker run --rm -d --name test-raspberry-container -p 5002:5001 bonjour-network-raspberry-test
        sleep 15
        curl -f http://localhost:5002/api/health || exit 1
        docker stop test-raspberry-container
    
    - name: Test Docker Compose
      run: |
        echo "ðŸ™ Test Docker Compose..."
        docker-compose up -d
        sleep 20
        curl -f http://localhost:5001/api/health || exit 1
        curl -f http://localhost:3000 || exit 1
        docker-compose down
    
    - name: Test Docker Compose Raspberry Pi
      run: |
        echo "ðŸ“ Test Docker Compose Raspberry Pi..."
        docker-compose -f docker-compose.raspberry-pi.yml up -d
        sleep 20
        curl -f http://localhost:5001/api/health || exit 1
        docker-compose -f docker-compose.raspberry-pi.yml down
    
    - name: Security audit
      run: |
        echo "ðŸ”’ Audit de sÃ©curitÃ©..."
        npm audit --audit-level=moderate || echo "âš ï¸ VulnÃ©rabilitÃ©s dÃ©tectÃ©es (niveau modÃ©rÃ©)"
        cd client && npm audit --audit-level=moderate || echo "âš ï¸ VulnÃ©rabilitÃ©s client dÃ©tectÃ©es"
        cd ../server && npm audit --audit-level=moderate || echo "âš ï¸ VulnÃ©rabilitÃ©s serveur dÃ©tectÃ©es"
    
    - name: Security tests
      run: |
        echo "ðŸ›¡ï¸ Tests de sÃ©curitÃ©..."
        cd server
        node security/security-test.js || echo "âš ï¸ Tests de sÃ©curitÃ© Ã©chouÃ©s"
    
    - name: Check for secrets
      run: |
        echo "ðŸ” VÃ©rification des secrets..."
        if grep -r "password\|secret\|key\|token" . --exclude-dir=node_modules --exclude-dir=.git --exclude=*.md | grep -v "example\|test\|TODO"; then
          echo "âŒ Secrets potentiels trouvÃ©s dans le code"
          exit 1
        else
          echo "âœ… Aucun secret trouvÃ©"
        fi
    
    - name: Test specific pages
      run: |
        echo "ðŸ“„ Test des pages spÃ©cifiques..."
        for page in "/" "/appareils" "/reseaux" "/dns"; do
          echo "Testing $page..."
          curl -f "http://localhost:3000$page" || exit 1
        done
    
    - name: Test all features (if Xvfb available)
      run: |
        echo "ðŸ§ª Test de toutes les fonctionnalitÃ©s..."
        if command -v xvfb-run &> /dev/null; then
          xvfb-run -a -s "-screen 0 1280x720x24" node tests/test-all-features.js || echo "âš ï¸ Tests complets Ã©chouÃ©s"
        else
          echo "â„¹ï¸ Xvfb non disponible, skip des tests complets"
        fi
    
    - name: Performance test
      run: |
        echo "âš¡ Test de performance..."
        # Test de temps de rÃ©ponse
        start_time=$(date +%s.%N)
        curl -s http://localhost:5001/api/health > /dev/null
        end_time=$(date +%s.%N)
        response_time=$(echo "$end_time - $start_time" | bc)
        echo "Temps de rÃ©ponse API: ${response_time}s"
        
        if (( $(echo "$response_time > 5.0" | bc -l) )); then
          echo "âš ï¸ Temps de rÃ©ponse Ã©levÃ©: ${response_time}s"
        else
          echo "âœ… Temps de rÃ©ponse acceptable: ${response_time}s"
        fi
    
    - name: Memory usage test
      run: |
        echo "ðŸ’¾ Test d'utilisation mÃ©moire..."
        # VÃ©rifier l'utilisation mÃ©moire du processus Node.js
        if pgrep -f "node.*index.js" > /dev/null; then
          memory_usage=$(ps -o rss= -p $(pgrep -f "node.*index.js") | awk '{sum+=$1} END {print sum/1024}')
          echo "Utilisation mÃ©moire serveur: ${memory_usage}MB"
          
          if (( $(echo "$memory_usage > 500" | bc -l) )); then
            echo "âš ï¸ Utilisation mÃ©moire Ã©levÃ©e: ${memory_usage}MB"
          else
            echo "âœ… Utilisation mÃ©moire acceptable: ${memory_usage}MB"
          fi
        else
          echo "â„¹ï¸ Serveur non trouvÃ© pour test mÃ©moire"
        fi
    
    - name: Cleanup
      if: always()
      run: |
        echo "ðŸ§¹ Nettoyage..."
        docker stop test-container test-raspberry-container 2>/dev/null || true
        docker-compose down 2>/dev/null || true
        docker-compose -f docker-compose.raspberry-pi.yml down 2>/dev/null || true
        pkill -f "npm start" 2>/dev/null || true
        pkill -f "node.*index.js" 2>/dev/null || true
    
    - name: Deploy (if main branch)
      if: github.ref == 'refs/heads/main'
      run: |
        echo "ðŸš€ DÃ©ploiement sur la branche main..."
        # Build des images de production
        docker build -t bonjour-network:latest .
        docker build -f Dockerfile.raspberry-pi -t bonjour-network:raspberry-latest .
        
        # Test des builds de production
        docker run --rm -d --name prod-test -p 5001:5001 bonjour-network:latest
        sleep 15
        curl -f http://localhost:5001/api/health || exit 1
        docker stop prod-test
        
        docker run --rm -d --name prod-raspberry-test -p 5002:5001 bonjour-network:raspberry-latest
        sleep 15
        curl -f http://localhost:5002/api/health || exit 1
        docker stop prod-raspberry-test
        
        echo "âœ… DÃ©ploiement rÃ©ussi"
    
    - name: Summary
      run: |
        echo ""
        echo "ðŸŽ‰ Tests unifiÃ©s terminÃ©s !"
        echo "ðŸ“Š RÃ©sumÃ©:"
        echo "  âœ… API endpoints"
        echo "  âœ… FonctionnalitÃ© API"
        echo "  âœ… AccessibilitÃ©"
        echo "  âœ… Navigateur headless"
        echo "  âœ… Build Docker"
        echo "  âœ… Docker Compose"
        echo "  âœ… Audit de sÃ©curitÃ©"
        echo "  âœ… Tests de sÃ©curitÃ©"
        echo "  âœ… VÃ©rification secrets"
        echo "  âœ… Pages spÃ©cifiques"
        echo "  âœ… Performance"
        echo "  âœ… Utilisation mÃ©moire"
        if [ "${{ github.ref }}" = "refs/heads/main" ]; then
          echo "  âœ… DÃ©ploiement production"
        fi 